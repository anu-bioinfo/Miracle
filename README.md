Calculating MIRACLE Score from Bulk Gene Expression Datasets
================
Tolga Turan
June 14, 2019

INTRODUCTION:
-------------

**MIRACLE** is short for "**M**ediators of **I**mmune **R**esponse **A**gainst **C**ancer in so**L**id micro**E**nvironments". The genesets are generated using a straigthforward approach as explained in the associated publication. Briefly, the cohorts where immune infiltrate has good prognosis association as well as the ones with opposite prognosis association are used as training sets. The markers generated by the training samples are used to calculate single-sample GeneSet Enrichment (ssGSE) scores and mathematical ratio of ssGSE scores of good prognosis cohorts to worse prognosis cohorts gives Miracle Score.

INSTALLATION:
-------------

First install the latest version of the dependency package "yaGST":

``` {.r}
library(devtools)
install_github("miccec/yaGST")
```

Then install Miracle as follows:

``` {.r}
library(devtools)
install_github("tolgaturan-github/Miracle")
```

USAGE:
------

To calculate Miracle score, use a gene expression matrix normalized by methods including but not limited to EDASeq for RNA-seq or Quantile or RMA for Microarrays.

Please note that Miracle has not been tested on Nanostring platforms or RNAseq RPKM, FPKM or TPM normalizations.

The accepted feature\_identifiers are "ens" for Ensemble Gene Ids; "u133p2" for Affymetrix U133p2 or U133A probe\_ids; "entrez" for Entrez Gene Ids; "gene" for Gene Symbols and "ilmn" for IlluminaHT12v3 or IlluminaHT12v4 microarray platforms.

### Example: Calculating Miracle Scores and Measuring Survival Association in TCGA-BLCA:

*Please note that this vignette makes use of "ggplot2" and "survival" packages which are not necessary for installation but necessary to replicate this vignette.*

Load normalized gene expression and Survival Data for TCGA-BLCA

``` {.r}
library(survival)
library(ggplot2)
library(Miracle)
data("SURV_BLCA","TCGA_BLCA_EDASeq_norm",package="Miracle") 
head(SURV_BLCA)
```

    ##              ID Time Status
    ## 8  TCGA.FD.A3B6 1005   TRUE
    ## 10 TCGA.FD.A3B3  974   TRUE
    ## 11 TCGA.DK.A3IU  706   TRUE
    ## 14 TCGA.XF.AAN2 1869   TRUE
    ## 15 TCGA.FD.A43Y  474   TRUE
    ## 19 TCGA.ZF.A9RN  615   TRUE

``` {.r}
TCGA_BLCA_EDASeq_norm[1:5, 1:5]
```

    ##                 TCGA.FD.A3B6 TCGA.FD.A3B3 TCGA.DK.A3IU TCGA.XF.AAN2
    ## ENSG00000000003        11.81        11.05         9.69        11.42
    ## ENSG00000000005         0.00         3.52         1.00         2.96
    ## ENSG00000000419        11.40        11.08        11.46        11.30
    ## ENSG00000000457         9.10         8.98         9.54         9.50
    ## ENSG00000000460         9.52         9.50         9.35         9.21
    ##                 TCGA.FD.A43Y
    ## ENSG00000000003        11.70
    ## ENSG00000000005         0.00
    ## ENSG00000000419        11.66
    ## ENSG00000000457         9.66
    ## ENSG00000000460         9.13

Calculate ICR and Miracle Scores and merge with survival data:

``` {.r}
TCGA_ICR_and_miracle_scores<-Calculate_Miracle(TCGA_BLCA_EDASeq_norm, "ens")
```

    ## Loading required package: doParallel

    ## Loading required package: foreach

    ## Loading required package: iterators

    ## Loading required package: parallel

``` {.r}
head(TCGA_ICR_and_miracle_scores)
```

    ##                    ICR   Miracle
    ## TCGA.FD.A3B6 0.8697658 0.9186238
    ## TCGA.FD.A3B3 0.8831050 0.9057638
    ## TCGA.DK.A3IU 0.9009755 0.9328145
    ## TCGA.XF.AAN2 0.8475331 0.8979655
    ## TCGA.FD.A43Y 0.8056991 0.8128846
    ## TCGA.ZF.A9RN 0.8638784 0.9093093

``` {.r}
all(rownames(TCGA_ICR_and_miracle_scores)==SURV_BLCA[,1])
```

    ## [1] TRUE

``` {.r}
TCGA_BLCA_Miracle_SURV<-cbind(SURV_BLCA, TCGA_ICR_and_miracle_scores)
head(TCGA_BLCA_Miracle_SURV)
```

    ##              ID Time Status       ICR   Miracle
    ## 8  TCGA.FD.A3B6 1005   TRUE 0.8697658 0.9186238
    ## 10 TCGA.FD.A3B3  974   TRUE 0.8831050 0.9057638
    ## 11 TCGA.DK.A3IU  706   TRUE 0.9009755 0.9328145
    ## 14 TCGA.XF.AAN2 1869   TRUE 0.8475331 0.8979655
    ## 15 TCGA.FD.A43Y  474   TRUE 0.8056991 0.8128846
    ## 19 TCGA.ZF.A9RN  615   TRUE 0.8638784 0.9093093

Calculate Survival association of ICR in TCGA\_BLCA Cohort:

``` {.r}
coxph(Surv(Time, Status)~ICR, data=TCGA_BLCA_Miracle_SURV)
```

    ## Call:
    ## coxph(formula = Surv(Time, Status) ~ ICR, data = TCGA_BLCA_Miracle_SURV)
    ## 
    ##        coef exp(coef) se(coef)      z     p
    ## ICR -0.9857    0.3732   0.9793 -1.007 0.314
    ## 
    ## Likelihood ratio test=1  on 1 df, p=0.317
    ## n= 405, number of events= 178

Calculate Survival association of Miracle in TCGA\_BLCA Cohort:

``` {.r}
coxph(Surv(Time, Status)~Miracle, data=TCGA_BLCA_Miracle_SURV)
```

    ## Call:
    ## coxph(formula = Surv(Time, Status) ~ Miracle, data = TCGA_BLCA_Miracle_SURV)
    ## 
    ##             coef exp(coef) se(coef)      z        p
    ## Miracle -4.81840   0.00808  1.05540 -4.565 4.98e-06
    ## 
    ## Likelihood ratio test=22.36  on 1 df, p=2.262e-06
    ## n= 405, number of events= 178

*Similar to this example, Miracle scores calculated by 'Calculate\_Miracle' function can be merged with immunotherapy datasets with response outcomes.*
